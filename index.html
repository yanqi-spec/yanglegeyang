<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>羊了个羊 · 超级地狱 Pro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
    }
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: #333;
      position: relative;
    }
    h1 {
      margin: 20px 0;
      font-size: 32px;
      color: #d32f2f;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    .stats {
      display: flex;
      gap: 18px;
      margin: 15px 0;
      font-size: 18px;
      font-weight: bold;
      flex-wrap: wrap;
      justify-content: center;
    }

    .tray {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 20px 0;
      width: 95%;
      max-width: 700px;
    }
    .tray-slot {
      width: 80px;
      height: 80px;
      border: 3px dashed #aaa;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .tray-slot.filled {
      border-style: solid;
      border-color: #4caf50;
    }
    .tray-slot img {
      width: 64px;
      height: 64px;
      object-fit: contain;
    }

    .game-area {
      position: relative;
      width: 95%;
      max-width: 700px;
      height: 600px;
      background: #fff9c4;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      overflow: hidden;
      perspective: 1000px;
    }

    .block {
      position: absolute;
      width: 80px;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 12px;
      background: white;
      box-shadow: 3px 3px 8px rgba(0,0,0,0.25);
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
      z-index: 1;
    }
    .block:hover {
      transform: translateY(-6px) scale(1.08);
      z-index: 10 !important;
    }
    .block.removed {
      opacity: 0.3;
      pointer-events: none;
    }
    .block.is-covered-hint {
      border: 2px solid red;
      box-shadow: 0 0 10px red;
    }
    .block.god-mode-hover {
      border: 3px solid gold;
      box-shadow: 0 0 15px gold;
    }
    .block img {
      width: 64px;
      height: 64px;
      object-fit: contain;
    }

    .block.eliminating {
      animation: eliminateEffect 0.6s forwards;
    }
    .block.god-eliminate {
      animation: godEliminateEffect 0.4s forwards;
    }
    @keyframes eliminateEffect {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.8; }
      100% { transform: scale(0); opacity: 0; }
    }
    @keyframes godEliminateEffect {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5) rotate(15deg); opacity: 0.7; }
      100% { transform: scale(0); opacity: 0; }
    }

    .controls {
      margin-top: 25px;
      display: flex;
      gap: 15px;
    }
    button {
      padding: 12px 20px;
      font-size: 18px;
      background: #ff6f00;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      margin: 0 8px;
      transition: background 0.3s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      white-space: nowrap;
    }
    button:hover {
      background: #e65100;
      transform: scale(1.05);
    }
    #godEliminateBtn {
      background: #d4af37;
    }
    #godEliminateBtn:hover {
      background: #b8860b;
    }

    .message {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
      height: 32px;
      color: #d32f2f;
      text-align: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s, visibility 0.4s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      background: white;
      width: 90%;
      max-width: 500px;
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      position: relative;
      transform: scale(0.9);
      animation: popIn 0.4s forwards;
    }
    @keyframes popIn {
      to { transform: scale(1); }
    }

    .danmaku-container {
      height: 60px;
      overflow: hidden;
      position: relative;
      margin: 15px 0;
      background: #fff8e1;
      border-radius: 10px;
      display: flex;
      align-items: center;
    }
    .danmaku-text {
      position: absolute;
      white-space: nowrap;
      font-size: 20px;
      color: #d32f2f;
      animation: scrollDanmaku 8s linear infinite;
    }
    @keyframes scrollDanmaku {
      from { transform: translateX(100%); }
      to { transform: translateX(-100%); }
    }

    .input-group {
      margin: 20px 0;
    }
    .input-group input {
      width: 70%;
      padding: 12px;
      font-size: 18px;
      border: 2px solid #ccc;
      border-radius: 10px;
      outline: none;
      text-align: center;
    }
    .input-group input:focus {
      border-color: #ff6f00;
    }
    .error {
      color: red;
      font-size: 16px;
      margin-top: 8px;
      min-height: 20px;
    }

    .record {
      font-size: 16px;
      color: #5d4037;
      background: rgba(255,255,255,0.7);
      padding: 6px 12px;
      border-radius: 10px;
      margin-top: 5px;
    }

    .god-mode-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      background: gold;
      color: #333;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: bold;
      z-index: 999;
      display: none;
    }
    .god-mode-badge.w无敌 {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      box-shadow: 0 0 15px #ffd700;
    }

    .hint-footer {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      color: #e91e63;
      padding: 8px 16px;
      border-radius: 12px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      writing-mode: vertical-rl;
      text-orientation: mixed;
      letter-spacing: 2px;
      z-index: 900;
      animation: fadeInRight 0.6s ease-out;
    }
    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateY(-50%) translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
      }
    }

    .history-panel {
      position: fixed;
      right: 20px;
      top: 120px;
      width: 220px;
      background: rgba(255, 255, 255, 0.85);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-size: 14px;
      z-index: 800;
      max-height: 600px;
      overflow-y: auto;
    }
    .history-panel h3 {
      margin-bottom: 10px;
      color: #d32f2f;
      text-align: center;
    }
    .history-item {
      margin: 8px 0;
      padding: 6px;
      background: #fff3e0;
      border-radius: 6px;
      font-size: 13px;
    }

    .music-player {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 999;
      width: 220px;
      height: 60px;
      border: none;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .leaderboard-list {
      text-align: left;
      margin: 20px 0;
      max-height: 200px;
      overflow-y: auto;
      padding: 0 10px;
    }
    .leaderboard-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 16px;
    }
    .leaderboard-item strong {
      color: #ff6f00;
    }

    #secondWinModal .danmaku-text {
      color: #4caf50;
      font-size: 22px;
    }
  </style>
</head>
<body>

  <div class="god-mode-badge" id="godModeBadge">👑 大佬模式 ON | ✨ 无敌消除</div>
  <div class="hint-footer">滑到下面可以撤回哟 | </div>

  <div class="history-panel" id="historyPanel">
    <h3>🎮 最近战绩（10次）</h3>
    <div id="historyContent">暂无记录</div>
  </div>

  <h1>🐑 羊了个羊 · 超级地狱 Pro</h1>
  
  <div class="stats">
    <div>关卡：<span id="level">1</span></div>
    <div>得分：<span id="score">0</span></div>
    <div>剩余：<span id="remaining">0</span></div>
    <div>撤回：<span id="undoCount">0</span> 次</div>
    <div class="record">最高分：<span id="highScore">0</span> | 最高关：<span id="highLevel">1</span></div>
  </div>

  <div class="tray" id="tray">
    <div class="tray-slot"></div>
    <div class="tray-slot"></div>
    <div class="tray-slot"></div>
    <div class="tray-slot"></div>
    <div class="tray-slot"></div>
    <div class="tray-slot"></div>
    <div class="tray-slot"></div>
  </div>

  <div class="game-area" id="gameArea"></div>

  <div class="message" id="message"></div>

  <div class="controls">
    <button onclick="newGame(currentLevel)">新游戏</button>
    <button onclick="requestUndo()">撤回（<span id="freeUndoHint">免费</span>）</button>
    <button id="godEliminateBtn" onclick="toggleGodEliminateMode()" style="display: none;">✨ 无敌消除模式</button>
  </div>

  <div class="modal-overlay" id="winModal">
    <div class="modal">
      <h2>🎉 第一关通关！</h2>
      <div class="danmaku-container">
        <div class="danmaku-text">太棒啦！来试试第二关怎么样吧~~祝你开心 🎉</div>
      </div>
      <div class="input-group">
        <input type="text" id="passInput" placeholder="请输入：加油" maxlength="10" />
        <div class="error" id="errorMsg"></div>
      </div>
      <button onclick="tryNextLevel()">确认进入第二关</button>
    </div>
  </div>

  <div class="modal-overlay" id="secondWinModal">
    <div class="modal">
      <h2>🏆 第二关通关！</h2>
      <div class="danmaku-container">
        <div class="danmaku-text">太牛了！敢挑战超级地狱第三关吗？😈</div>
      </div>
      <div class="input-group">
        <input type="text" id="secondPassInput" placeholder="请输入：我不怕" maxlength="10" />
        <div class="error" id="secondErrorMsg"></div>
      </div>
      <button onclick="tryThirdLevel()">确认进入第三关</button>
    </div>
  </div>

  <div class="modal-overlay" id="undoModal">
    <div class="modal">
      <h2>🥺 你求求我</h2>
      <div id="undoPrompt">再让你撤回一次...可以吗？</div>
      <div class="input-group">
        <input type="text" id="undoInput" placeholder="请输入提示内容" maxlength="12" />
        <div class="error" id="undoError"></div>
      </div>
      <button onclick="confirmUndo()">求你了！</button>
    </div>
  </div>

  <div class="modal-overlay" id="fullTrayModal">
    <div class="modal">
      <h2>⚠️ 卡槽已满</h2>
      <p style="margin: 15px 0;">卡槽已满，不可点击新卡片！</p>
      <button onclick="document.getElementById('fullTrayModal').classList.remove('active')">确认</button>
    </div>
  </div>

  <div class="modal-overlay" id="failModal">
    <div class="modal">
      <h2>❌ 槽位已满！</h2>
      <p style="margin: 15px 0;">挑战失败，请撤回操作或重新开始。</p>
      <button onclick="document.getElementById('failModal').classList.remove('active')">确定</button>
    </div>
  </div>

  <div class="modal-overlay" id="rankModal">
    <div class="modal">
      <h2>🏆 通关排行榜</h2>
      <p>本次成绩：得分 <strong id="finalScore">0</strong>，撤回 <strong id="finalUndo">0</strong> 次</p>
      <div class="leaderboard-list" id="leaderboardList"></div>
      <button onclick="document.getElementById('rankModal').classList.remove('active')">关闭</button>
    </div>
  </div>

  <iframe 
    class="music-player"
    src="//music.163.com/outchain/player?type=2&id=2600493765&auto=1&height=66"
    frameborder="0"
    allowfullscreen>
  </iframe>

  <script>
    const baseImageUrls = [
      'https://pic1.imgdb.cn/item/6938d02af9354404e342de8b.jpg',
      'https://pic1.imgdb.cn/item/6938d02af9354404e342de88.webp',
      'https://pic1.imgdb.cn/item/6938d02af9354404e342de8a.jpg',
      'https://pic1.imgdb.cn/item/6938d02af9354404e342de8c.jpg',
      'https://pic1.imgdb.cn/item/6938d02af9354404e342de89.webp',
      'https://pic1.imgdb.cn/item/6937f2cb00233646958d8a46.jpg',
      'https://pic1.imgdb.cn/item/6937f2c600233646958d8a44.webp',
      'https://pic1.imgdb.cn/item/6937f2c300233646958d8a41.webp',
      'https://pic1.imgdb.cn/item/6937f2c000233646958d8a40.jpg',
      'https://pic1.imgdb.cn/item/6937f2bc00233646958d8a3a.png'
    ];

    const thirdLevelImageUrls = [
      'https://pic1.imgdb.cn/item/6939122b6166b8110132922b.jpg',
      'https://pic1.imgdb.cn/item/6939122b6166b8110132922a.jpg',
      'https://pic1.imgdb.cn/item/6939122b6166b81101329227.jpg',
      'https://pic1.imgdb.cn/item/693912256166b81101329212.webp',
      'https://pic1.imgdb.cn/item/693912256166b81101329213.webp',
      'https://pic1.imgdb.cn/item/693912256166b81101329215.jpg',
      'https://pic1.imgdb.cn/item/693912256166b81101329216.jpg',
      'https://pic1.imgdb.cn/item/693912256166b81101329214.jpg',
      'https://pic1.imgdb.cn/item/693918e46166b8110132a1c2.jpg',
      'https://pic1.imgdb.cn/item/693918e46166b8110132a1c6.jpg',
      'https://pic1.imgdb.cn/item/693918e46166b8110132a1c3.jpg',
      'https://pic1.imgdb.cn/item/693918e46166b8110132a1c5.jpg',
      'https://pic1.imgdb.cn/item/693918e46166b8110132a1c8.jpg',
      'https://pic1.imgdb.cn/item/693918e46166b8110132a1c4.jpg',
      'https://pic1.imgdb.cn/item/693918ff6166b8110132a212.jpg',
      'https://pic1.imgdb.cn/item/693918fe6166b8110132a211.jpg'
    ];

    let currentLevel = 1;
    const traySize = 7;
    let blocks = [];
    let tray = [];
    let history = [];
    let score = 0;
    let totalBlocks = 0;
    let freeUndoUsed = false;
    let godMode = false;
    let godEliminateMode = false;
    let undoCount = 0;
    let startTime = Date.now();

    const mercyPhrases = [
      { key: '求求你了', display: '求求你了' },
      { key: '我错了', display: '我错了' },
      { key: '放过我吧', display: '放过我吧' },
      { key: '羊羊大人', display: '羊羊大人' },
      { key: '给次机会', display: '给次机会' }
    ];
    let currentMercy = null;

    let highScore = parseInt(localStorage.getItem('sheepHighScore')) || 0;
    let highLevel = parseInt(localStorage.getItem('sheepHighLevel')) || 1;
    let leaderboard = JSON.parse(localStorage.getItem('sheepLeaderboard') || '[]');
    let recentGames = JSON.parse(localStorage.getItem('sheepRecentGames') || '[]');

    document.getElementById('highScore').textContent = highScore;
    document.getElementById('highLevel').textContent = highLevel;
    updateHistoryPanel();

    function saveRecord() {
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('sheepHighScore', highScore);
        document.getElementById('highScore').textContent = highScore;
      }
      if (currentLevel > highLevel) {
        highLevel = currentLevel;
        localStorage.setItem('sheepHighLevel', highLevel);
        document.getElementById('highLevel').textContent = highLevel;
      }
    }

    function addToLeaderboard(finalScore, undoCount) {
      const timeSec = Math.floor((Date.now() - startTime) / 1000);
      const record = { level: currentLevel, score: finalScore, undoCount, timeSec };
      leaderboard.unshift(record);
      if (leaderboard.length > 5) leaderboard.pop();
      localStorage.setItem('sheepLeaderboard', JSON.stringify(leaderboard));
    }

    function addRecentGame(finalScore, timeSec) {
      recentGames.unshift({ score: finalScore, timeSec });
      if (recentGames.length > 10) recentGames.pop();
      localStorage.setItem('sheepRecentGames', JSON.stringify(recentGames));
      updateHistoryPanel();
    }

    function updateHistoryPanel() {
      const content = document.getElementById('historyContent');
      if (recentGames.length === 0) {
        content.innerHTML = '暂无记录';
        return;
      }
      let html = '';
      recentGames.slice(0, 10).forEach((game, i) => {
        html += `<div class="history-item">第${i+1}次：得分 ${game.score}，用时 ${game.timeSec}秒</div>`;
      });
      content.innerHTML = html;
    }

    function showLeaderboard(finalScore, undoCount) {
      const timeSec = Math.floor((Date.now() - startTime) / 1000);
      addToLeaderboard(finalScore, undoCount);
      addRecentGame(finalScore, timeSec);
      document.getElementById('finalScore').textContent = finalScore;
      document.getElementById('finalUndo').textContent = undoCount;
      const listEl = document.getElementById('leaderboardList');
      listEl.innerHTML = '';
      leaderboard.forEach((rec, i) => {
        const item = document.createElement('div');
        item.className = 'leaderboard-item';
        item.textContent = `#${i+1} 关卡${rec.level} | 得分 ${rec.score} | 撤回 ${rec.undoCount} 次 | ${rec.timeSec}s`;
        listEl.appendChild(item);
      });
      document.getElementById('rankModal').classList.add('active');
    }

    function newGame(level) {
      currentLevel = level;
      document.getElementById('level').textContent = level;
      document.getElementById('message').textContent = '';
      ['winModal', 'secondWinModal', 'undoModal', 'failModal', 'fullTrayModal', 'rankModal'].forEach(id => {
        document.getElementById(id).classList.remove('active');
      });
      const gameArea = document.getElementById('gameArea');
      gameArea.innerHTML = '';
      tray = [];
      history = [];
      score = 0;
      undoCount = 0;
      freeUndoUsed = false;
      godEliminateMode = false;
      updateUI();
      startTime = Date.now();

      let selectedImages, layers, allItems;

      if (level === 1) {
        selectedImages = [...baseImageUrls].sort(() => 0.5 - Math.random()).slice(0, 6);
        allItems = [];
        selectedImages.forEach(img => {
          for (let i = 0; i < 9; i++) allItems.push(img);
        });
        allItems = allItems.sort(() => 0.5 - Math.random());
        totalBlocks = allItems.length;
        layers = [{ count: 15, offset: 0 }, { count: 15, offset: 40 }, { count: 24, offset: 80 }];
      } else if (level === 2) {
        selectedImages = [...baseImageUrls].sort(() => 0.5 - Math.random()).slice(0, 9);
        allItems = [];
        selectedImages.forEach(img => {
          for (let i = 0; i < 15; i++) allItems.push(img);
        });
        allItems = allItems.sort(() => 0.5 - Math.random());
        totalBlocks = allItems.length;
        layers = [
          { count: 12, offset: 0 },
          { count: 16, offset: 25 },
          { count: 20, offset: 50 },
          { count: 24, offset: 75 },
          { count: 28, offset: 100 },
          { count: 32, offset: 125 },
          { count: 36, offset: 150 }
        ];
      } else if (level === 3) {
        selectedImages = [...thirdLevelImageUrls];
        allItems = [];
        selectedImages.forEach(img => {
          for (let i = 0; i < 10; i++) allItems.push(img);
        });
        allItems = allItems.sort(() => 0.5 - Math.random());
        totalBlocks = allItems.length;
        layers = [
          { count: 15, offset: 0 },
          { count: 20, offset: 20 },
          { count: 25, offset: 40 },
          { count: 30, offset: 60 },
          { count: 35, offset: 80 },
          { count: 40, offset: 100 },
          { count: 45, offset: 120 },
          { count: 50, offset: 140 },
          { count: 55, offset: 160 },
          { count: 60, offset: 180 },
          { count: 65, offset: 200 },
          { count: 70, offset: 220 }
        ];
      }

      blocks = [];
      let index = 0;
      layers.forEach((layer, layerIndex) => {
        const cols = level === 3 ? 
          [5, 6, 7, 8, 9, 10, 10, 11, 11, 12, 12, 13][layerIndex] || 13 : 
          [3, 4, 4, 5, 5, 5, 6][layerIndex] || 6;
        const rows = Math.ceil(layer.count / cols);
        for (let i = 0; i < layer.count && index < allItems.length; i++) {
          const col = i % cols;
          const row = Math.floor(i / cols);
          const xOffset = level === 3 ? 40 : 70;
          const xStep = level === 3 ? 65 : 80;
          const yOffset = level === 3 ? 20 : 30;
          const yStep = level === 3 ? 55 : 65;
          const randomRange = level === 3 ? 8 : 12;
          
          const x = xOffset + col * xStep + Math.random() * randomRange - (randomRange/2);
          const y = yOffset + row * yStep + layer.offset;
          blocks.push({
            id: index,
            imageUrl: allItems[index],
            x: x,
            y: y,
            layer: layer.offset,
            removed: false,
            coveredBy: []
          });
          index++;
        }
      });

      blocks.forEach(b1 => {
        blocks.forEach(b2 => {
          if (b2.layer > b1.layer) {
            const dx = Math.abs(b1.x - b2.x);
            const dy = Math.abs(b1.y - b2.y);
            const thresholdX = level === 3 ? 70 : 85;
            const thresholdY = level === 3 ? 65 : 75;
            if (dx < thresholdX && dy < thresholdY) {
              b1.coveredBy.push(b2.id);
            }
          }
        });
      });

      renderBlocks();
      document.getElementById('remaining').textContent = totalBlocks;
      document.getElementById('undoCount').textContent = undoCount;
      document.getElementById('freeUndoHint').textContent = '免费';
      updateGodEliminateBtn();
    }

    // 修复核心：无敌模式强制可点击
    function isClickable(block) {
      if (block.removed) return false;
      if (godMode && godEliminateMode) return true;
      return block.coveredBy.every(id => {
        const b = blocks.find(x => x.id === id);
        return b && b.removed;
      });
    }

    function toggleGodEliminateMode() {
      if (!godMode) {
        alert('请先开启大佬模式！（按6键6次）');
        return;
      }
      godEliminateMode = !godEliminateMode;
      const btn = document.getElementById('godEliminateBtn');
      btn.textContent = godEliminateMode ? '✨ 关闭无敌消除' : '✨ 无敌消除模式';
      document.getElementById('message').textContent = godEliminateMode ? 
        '🔥 无敌消除模式已开启！点击任意方块直接消除同类型所有方块' : 
        '🔸 无敌消除模式已关闭';
      renderBlocks();
    }

    function updateGodEliminateBtn() {
      const btn = document.getElementById('godEliminateBtn');
      btn.style.display = godMode ? 'inline-block' : 'none';
      btn.textContent = godEliminateMode ? '✨ 关闭无敌消除' : '✨ 无敌消除模式';
    }

    function godEliminateBlocks(imageUrl) {
      if (!godMode || !godEliminateMode) return;
      const targetBlocks = blocks.filter(b => !b.removed && b.imageUrl === imageUrl);
      if (targetBlocks.length === 0) return;
      
      history.push({ 
        tray: [...tray], 
        removed: targetBlocks.map(b => b.id),
        isGodEliminate: true,
        imageUrl: imageUrl
      });
      
      targetBlocks.forEach(block => {
        block.removed = true;
        totalBlocks--;
        
        const animDiv = document.createElement('div');
        animDiv.className = 'block god-eliminate';
        animDiv.style.position = 'absolute';
        animDiv.style.left = (block.x - 40) + 'px';
        animDiv.style.top = (block.y - 40) + 'px';
        animDiv.style.width = '80px';
        animDiv.style.height = '80px';
        animDiv.innerHTML = `<img src="${block.imageUrl}" style="width:64px;height:64px;object-fit:contain;">`;
        document.getElementById('gameArea').appendChild(animDiv);
        setTimeout(() => animDiv.remove(), 400);
      });
      
      score += targetBlocks.length * 10;
      updateUI();
      document.getElementById('remaining').textContent = totalBlocks;
      document.getElementById('message').textContent = `💥 消除了 ${targetBlocks.length} 个方块！+${targetBlocks.length * 10} 分`;
      
      if (totalBlocks === 0) {
        saveRecord();
        let msg = '🏆 超级地狱通关！大神！';
        if (godMode) msg += ' 👑（大佬认证）';
        document.getElementById('message').textContent = msg;
        setTimeout(() => showLeaderboard(score, undoCount), 1000);
      }
    }

    function renderBlocks() {
      const gameArea = document.getElementById('gameArea');
      gameArea.innerHTML = '';

      const isFailed = tray.length > traySize;

      blocks.forEach(block => {
        if (block.removed) return;

        const div = document.createElement('div');
        div.className = 'block';

        // 无敌消除模式优先绑定点击事件
        if (godMode && godEliminateMode) {
          div.classList.add('god-mode-hover');
          div.style.zIndex = '999';
          div.style.opacity = '1';
          div.onclick = () => clickBlock(block.id);
        } else if (isFailed) {
          div.style.opacity = '0.4';
          div.style.cursor = 'default';
          div.style.transform = 'none';
        } else if (isClickable(block)) {
          div.style.zIndex = '5';
          div.onclick = () => clickBlock(block.id);
        } else {
          div.style.opacity = '0.4';
          div.style.cursor = 'default';
        }

        if (godMode && block.coveredBy.length > 0 && !isFailed && !godEliminateMode) {
          div.classList.add('is-covered-hint');
        }

        const img = document.createElement('img');
        img.src = block.imageUrl;
        img.alt = "tile";
        div.appendChild(img);
        div.style.left = (block.x - 40) + 'px';
        div.style.top = (block.y - 40) + 'px';
        gameArea.appendChild(div);
      });
      renderTray();
    }

    function renderTray() {
      const slots = document.querySelectorAll('.tray-slot');
      slots.forEach((slot, i) => {
        slot.innerHTML = '';
        slot.className = 'tray-slot';
        if (i < tray.length) {
          const img = document.createElement('img');
          img.src = tray[i];
          slot.appendChild(img);
          slot.classList.add('filled');
        }
      });
    }

    function clickBlock(id) {
      const block = blocks.find(b => b.id === id);
      if (!block || block.removed) return;

      if (godMode && godEliminateMode) {
        godEliminateBlocks(block.imageUrl);
        renderBlocks();
        return;
      }

      if (tray.length >= traySize) {
        document.getElementById('fullTrayModal').classList.add('active');
        return;
      }

      if (!isClickable(block)) return;

      history.push({ tray: [...tray], removed: block.id });

      block.removed = true;
      tray.push(block.imageUrl);
      checkEliminate();
      totalBlocks--;
      document.getElementById('remaining').textContent = totalBlocks;

      if (tray.length > traySize) {
        document.getElementById('failModal').classList.add('active');
        saveRecord();
      } else if (totalBlocks === 0) {
        saveRecord();
        if (currentLevel === 1) {
          setTimeout(() => document.getElementById('winModal').classList.add('active'), 500);
        } else if (currentLevel === 2) {
          setTimeout(() => document.getElementById('secondWinModal').classList.add('active'), 500);
        } else {
          let msg = '🏆 超级地狱通关！大神！';
          if (godMode) msg += ' 👑（大佬认证）';
          document.getElementById('message').textContent = msg;
          setTimeout(() => showLeaderboard(score, undoCount), 1000);
        }
      }

      renderBlocks();
    }

    function checkEliminate() {
      if (tray.length < 3) return;
      const last = tray[tray.length - 1];
      let count = 0;
      for (let i = tray.length - 1; i >= 0; i--) {
        if (tray[i] === last) count++;
        if (count === 3) {
          const slots = document.querySelectorAll('.tray-slot');
          for (let j = 0; j < slots.length; j++) {
            if (j < tray.length && tray[j] === last) {
              const slot = slots[j];
              const img = slot.querySelector('img');
              if (img) {
                const animDiv = document.createElement('div');
                animDiv.className = 'block eliminating';
                animDiv.style.position = 'absolute';
                animDiv.style.left = slot.offsetLeft + 'px';
                animDiv.style.top = slot.offsetTop + 'px';
                animDiv.style.width = '80px';
                animDiv.style.height = '80px';
                animDiv.innerHTML = `<img src="${last}" style="width:64px;height:64px;object-fit:contain;">`;
                document.getElementById('tray').appendChild(animDiv);
                setTimeout(() => animDiv.remove(), 600);
              }
            }
          }

          tray = tray.filter(item => item !== last);
          const scoreAdd = currentLevel === 3 ? 50 : 30;
          score += scoreAdd;
          updateUI();
          return;
        }
      }
    }

    function updateUI() {
      document.getElementById('score').textContent = score;
    }

    function addDifficultyLayers() {
      if (currentLevel === 2) {
        const extraLayers = 3;
        const extraBlocksPerLayer = 12;
        let newBlocks = [];
        const selectedImages = [...baseImageUrls].sort(() => 0.5 - Math.random()).slice(0, 7);
        let baseOffset = Math.max(...blocks.map(b => b.layer)) + 30;
        for (let l = 0; l < extraLayers; l++) {
          for (let i = 0; i < extraBlocksPerLayer; i++) {
            const x = 70 + (i % 6) * 75 + Math.random() * 12 - 6;
            const y = 30 + Math.floor(i / 6) * 65 + baseOffset + l * 30;
            const img = selectedImages[Math.floor(Math.random() * selectedImages.length)];
            const newId = blocks.length + newBlocks.length;
            newBlocks.push({
              id: newId,
              imageUrl: img,
              x: x,
              y: y,
              layer: baseOffset + l * 30,
              removed: false,
              coveredBy: []
            });
          }
        }
        newBlocks.forEach(nb => {
          blocks.forEach(b => {
            if (b.layer < nb.layer) {
              const dx = Math.abs(nb.x - b.x);
              const dy = Math.abs(nb.y - b.y);
              if (dx < 85 && dy < 75) {
                b.coveredBy.push(nb.id);
              }
            }
          });
        });
        blocks.push(...newBlocks);
        totalBlocks += newBlocks.length;
        document.getElementById('remaining').textContent = totalBlocks;
        renderBlocks();
        document.getElementById('message').textContent = `⚠️ 难度升级！新增 ${extraLayers} 层方块！`;
        setTimeout(() => {
          if (totalBlocks > 0) document.getElementById('message').textContent = '';
        }, 3000);
      } else if (currentLevel === 3) {
        const extraLayers = 4;
        const extraBlocksPerLayer = 18;
        let newBlocks = [];
        const selectedImages = [...thirdLevelImageUrls];
        let baseOffset = Math.max(...blocks.map(b => b.layer)) + 25;
        for (let l = 0; l < extraLayers; l++) {
          for (let i = 0; i < extraBlocksPerLayer; i++) {
            const x = 40 + (i % 8) * 65 + Math.random() * 8 - 4;
            const y = 20 + Math.floor(i / 8) * 55 + baseOffset + l * 20;
            const img = selectedImages[Math.floor(Math.random() * selectedImages.length)];
            const newId = blocks.length + newBlocks.length;
            newBlocks.push({
              id: newId,
              imageUrl: img,
              x: x,
              y: y,
              layer: baseOffset + l * 20,
              removed: false,
              coveredBy: []
            });
          }
        }
        newBlocks.forEach(nb => {
          blocks.forEach(b => {
            if (b.layer < nb.layer) {
              const dx = Math.abs(nb.x - b.x);
              const dy = Math.abs(nb.y - b.y);
              if (dx < 70 && dy < 65) {
                b.coveredBy.push(nb.id);
              }
            }
          });
        });
        blocks.push(...newBlocks);
        totalBlocks += newBlocks.length;
        document.getElementById('remaining').textContent = totalBlocks;
        renderBlocks();
        document.getElementById('message').textContent = `😈 超级惩罚！新增 ${extraLayers} 层地狱方块！`;
        setTimeout(() => {
          if (totalBlocks > 0) document.getElementById('message').textContent = '';
        }, 3000);
      }
    }

    function requestUndo() {
      if (history.length === 0) {
        alert('没有可撤回的操作！');
        return;
      }
      if (godMode) {
        performUndo();
        return;
      }
      if (!freeUndoUsed) {
        freeUndoUsed = true;
        document.getElementById('freeUndoHint').textContent = '需请求';
        performUndo();
      } else {
        if (currentLevel === 3) {
          mercyPhrases.push(
            { key: '我真的错了', display: '我真的错了' },
            { key: '羊羊求求你', display: '羊羊求求你' },
            { key: '给我一次机会', display: '给我一次机会' }
          );
        }
        currentMercy = mercyPhrases[Math.floor(Math.random() * mercyPhrases.length)];
        document.getElementById('undoPrompt').textContent = `请输入：“${currentMercy.display}”`;
        document.getElementById('undoInput').placeholder = `请输入：${currentMercy.display}`;
        document.getElementById('undoInput').value = '';
        document.getElementById('undoError').textContent = '';
        document.getElementById('undoModal').classList.add('active');
      }
    }

    function confirmUndo() {
      const input = document.getElementById('undoInput').value.trim();
      const errorMsg = document.getElementById('undoError');
      if (input.toLowerCase().replace(/\s/g, '') === currentMercy.key.toLowerCase().replace(/\s/g, '')) {
        document.getElementById('undoModal').classList.remove('active');
        performUndo();
      } else {
        errorMsg.textContent = currentLevel === 3 ? '说对了才行哦～地狱模式可没那么容易' : '说对了才行哦～';
        setTimeout(() => errorMsg.textContent = '', 2000);
      }
    }

    function performUndo() {
      if (history.length === 0) return;

      const last = history.pop();
      if (last.isGodEliminate) {
        last.removed.forEach(id => {
          const block = blocks.find(b => b.id === id);
          if (block) block.removed = false;
        });
        totalBlocks += last.removed.length;
        score -= last.removed.length * 10;
        if (score < 0) score = 0;
      } else {
        tray = [...last.tray];
        const block = blocks.find(b => b.id === last.removed);
        if (block) block.removed = false;
        totalBlocks++;
        
        const scoreSub = currentLevel === 3 ? 50 : 30;
        score -= scoreSub;
        if (score < 0) score = 0;
      }

      undoCount++;
      updateUI();
      document.getElementById('undoCount').textContent = undoCount;

      if (currentLevel === 2 && undoCount % 2 === 0) {
        setTimeout(addDifficultyLayers, 500);
      } else if (currentLevel === 3 && undoCount % 1 === 0) {
        setTimeout(addDifficultyLayers, 300);
      }

      document.getElementById('remaining').textContent = totalBlocks;

      if (tray.length <= traySize) {
        document.getElementById('failModal').classList.remove('active');
        document.getElementById('message').textContent = '';
      }

      renderBlocks();
    }

    function tryNextLevel() {
      const input = document.getElementById('passInput').value.trim();
      const errorMsg = document.getElementById('errorMsg');
      if (input.toLowerCase() === '加油') {
        document.getElementById('winModal').classList.remove('active');
        newGame(2);
      } else {
        errorMsg.textContent = '请输入“加油”才能进入第二关哦～';
        setTimeout(() => errorMsg.textContent = '', 2000);
      }
    }

    function tryThirdLevel() {
      const input = document.getElementById('secondPassInput').value.trim();
      const errorMsg = document.getElementById('secondErrorMsg');
      if (input.toLowerCase() === '我不怕') {
        document.getElementById('secondWinModal').classList.remove('active');
        newGame(3);
      } else {
        errorMsg.textContent = '请输入“我不怕”才能进入第三关哦～';
        setTimeout(() => errorMsg.textContent = '', 2000);
      }
    }

    // 大佬模式：按 6 键 6 次
    let sixCount = 0;
    let lastSixTime = 0;
    document.addEventListener('keydown', (e) => {
      if (e.key === '6') {
        const now = Date.now();
        if (now - lastSixTime > 3000) sixCount = 0;
        sixCount++;
        lastSixTime = now;
        if (sixCount >= 6) {
          godMode = !godMode;
          document.getElementById('godModeBadge').style.display = godMode ? 'block' : 'none';
          // 更新无敌消除按钮
          updateGodEliminateBtn();
          sixCount = 0;
          if (godMode) {
            alert('👑 大佬模式已开启！\n- 无限撤回\n- 覆盖关系可见\n- 通关自动认证\n- 第三关也能轻松过\n- 新增：无敌消除模式（点击按钮开启）');
          } else {
            godEliminateMode = false; // 关闭无敌消除
            updateGodEliminateBtn();
            alert('😐 大佬模式已关闭');
          }
          renderBlocks();
        }
      }
    });

    // 初始化游戏
    newGame(1);
  </script>
</body>
</html>